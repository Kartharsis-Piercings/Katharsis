{% extends 'base.html' %}

{% block title %}{{ product.name }} | Katharsis{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='product_detail.css') }}">
{% endblock %}

{% block content %}
<section class="product-detail-section">
    <div class="container">
        <div class="product-detail-container">
            <!-- Galería de imágenes -->
            <div class="product-gallery">
                <div class="main-image-carousel">
                    <div class="carousel-track-main">
                        {% for image in product.images %}
                        <div class="carousel-slide-main">
                            <img src="{{ url_for('static', filename=image) }}" alt="{{ product.name }} vista {{ loop.index }}" id="main-product-image">
                        </div>
                        {% endfor %}
                    </div>
                    <button class="carousel-button-main prev">&#10094;</button>
                    <button class="carousel-button-main next">&#10095;</button>
                </div>
                <div class="thumbnails">
                    {% for image in product.images %}
                    <img src="{{ url_for('static', filename=image) }}" 
                         alt="{{ product.name }} vista {{ loop.index }}"
                         class="{% if loop.first %}active{% endif %}"
                         data-image="{{ url_for('static', filename=image) }}">
                    {% endfor %}
                </div>
            </div>
            

            <!-- Información del producto -->
            <div class="product-info">
                <h1>{{ product.name }}</h1>
                
                <div class="product-meta">
                    <span class="category">{{ product.category | capitalize }}</span>
                    <span class="material">{{ product.material | capitalize }}</span>
                    {% if product.is_new %}<span class="badge-new">Nuevo</span>{% endif %}
                </div>
                
                <div class="product-price">
                    {% if product.on_sale %}
                    <span class="current-price">S/ {{ product.sale_price | number_format }}</span>
                    <span class="old-price">S/ {{ product.price | number_format }}</span>
                    <span class="discount">-{{ ((product.price - product.sale_price) / product.price * 100) | round | int }}%</span>
                    {% else %}
                    <span class="current-price">S/ {{ product.price | number_format }}</span>
                    {% endif %}
                </div>
                
                <div class="product-description">
                    <p>{{ product.description }}</p>
                </div>
                
                <form method="POST" action="{{ url_for('add_to_cart') }}" class="add-to-cart-form">
                    <input type="hidden" name="product_id" value="{{ product.id }}">
                    
                    <div class="form-group">
                        <label for="size">Tamaño:</label>
                        <select name="size" id="size" required>
                            <option value="" disabled selected>Selecciona tamaño</option>
                            {% for size in product.stock.keys() %}
                            <option value="{{ size }}">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity">Cantidad:</label>
                        <div class="quantity-control">
                            <button type="button" class="quantity-btn minus">-</button>
                            <input type="number" name="quantity" id="quantity" value="1" min="1" max="10">
                            <button type="button" class="quantity-btn plus">+</button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-add-cart">Añadir al carrito</button>
                </form>
                
                <div class="info-accordion">
                    <div class="accordion-item">
                        <button class="accordion-header">
                            <span><i class="fas fa-gem"></i> Beneficios</span>
                            <i class="fas fa-chevron-down arrow-icon"></i>
                        </button>
                        <div class="accordion-content">
                            <ul>
                                <li>Material Titanio ASTM F-136 Grado Implante</li>
                                <li>Resistente al agua y al sudor</li>
                                <li>Garantía contra defectos de fábrica</li>
                            </ul>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <button class="accordion-header">
                            <span><i class="fas fa-ruler-combined"></i> Especificaciones</span>
                            <i class="fas fa-chevron-down arrow-icon"></i>
                        </button>
                        <div class="accordion-content">
                            {% if product.details %}
                            <ul>
                                {% if product.details.gauge %}<li><strong>Grosor:</strong> {{ product.details.gauge }}</li>{% endif %}
                                {% if product.details.closure_type %}<li><strong>Tipo de cierre:</strong> {{ product.details.closure_type }}</li>{% endif %}
                                {% if product.details.anodization %}<li><strong>Anodización:</strong> {{ product.details.anodization }}</li>{% endif %}
                                {% if product.details.material %}<li><strong>Material:</strong> {{ product.details.material }}</li>{% endif %}
                                {% if product.details.stone_type %}<li><strong>Tipo de Gema:</strong> {{ product.details.stone_type }}</li>{% endif %}
                                {% if product.details.dimensions %}<li><strong>Dimensiones:</strong> {{ product.details.dimensions }}</li>{% endif %}
                            </ul>
                            {% endif %}
                        </div>
                    </div>

                    <div class="accordion-item">
                        <button class="accordion-header">
                            <span><i class="fas fa-truck"></i> Envíos y Plazos de Entrega</span>
                            <i class="fas fa-chevron-down arrow-icon"></i>
                        </button>
                        <div class="accordion-content">
                            <ul>
                                <li><strong>Tarapoto, Morales, La Banda:</strong> 1 día hábil.</li>
                                <li><strong>Provincias y otros distritos:</strong> 3 a 4 días hábiles.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Productos relacionados -->
        {% if related_products %}
        <div class="related-products">
            <h2>Productos Relacionados</h2>
            <div class="products-grid">
                {% for product in related_products %}
                <div class="product-card">
                    <div class="product-image">
                        <a href="{{ url_for('product_detail', product_id=product.id) }}">
                            <img src="{{ url_for('static', filename=product.images[0]) }}" alt="{{ product.name }}">
                        </a>
                        <div class="product-badges">
                            {% if product.is_new %}<span class="badge-new">Nuevo</span>{% endif %}
                            {% if product.on_sale %}<span class="badge-sale">-{{ ((product.price - product.sale_price) / product.price * 100) | round | int }}%</span>{% endif %}
                        </div>
                    </div>
                    <div class="product-info">
                        <h3><a href="{{ url_for('product_detail', product_id=product.id) }}">{{ product.name }}</a></h3>
                        <p class="product-category">{{ product.category | capitalize }}</p>
                        <div class="product-price">
                            {% if product.on_sale %}
                            <span class="current-price">S/ {{ product.sale_price | number_format }}</span>
                            <span class="old-price">S/ {{ product.price | number_format }}</span>
                            {% else %}
                            <span class="current-price">S/ {{ product.price | number_format }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// --- LÓGICA MEJORADA DE LA GALERÍA DE IMÁGENES ---
const track = document.querySelector('.carousel-track-main');
// Solo activar si hay imágenes y más de una
if (track && track.children.length > 0) {
    const slides = Array.from(track.children);
    const thumbnails = document.querySelectorAll('.thumbnails img');
    let currentIndex = 0;

    // Función central para mover el carrusel y actualizar las miniaturas
    const moveToSlide = (newIndex) => {
        // Mueve el track del carrusel
        track.style.transform = `translateX(-${100 * newIndex}%)`;

        // Actualiza la clase 'active' en la miniatura correspondiente
        thumbnails[currentIndex].classList.remove('active');
        thumbnails[newIndex].classList.add('active');

        currentIndex = newIndex;
    };

    // Event listeners para los botones del carrusel (solo si hay más de una imagen)
    if (slides.length > 1) {
        const nextButton = document.querySelector('.carousel-button-main.next');
        const prevButton = document.querySelector('.carousel-button-main.prev');

        nextButton.addEventListener('click', () => {
            const nextIndex = (currentIndex + 1) % slides.length; // Bucle hacia adelante
            moveToSlide(nextIndex);
        });

        prevButton.addEventListener('click', () => {
            const prevIndex = (currentIndex - 1 + slides.length) % slides.length; // Bucle hacia atrás
            moveToSlide(prevIndex);
        });
    } else {
        // Oculta los botones si solo hay una imagen
        document.querySelector('.carousel-button-main.next').style.display = 'none';
        document.querySelector('.carousel-button-main.prev').style.display = 'none';
    }


    // Event listeners para las miniaturas
    thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', () => {
            moveToSlide(index);
        });
    });
}

// Controles de cantidad
document.querySelector('.quantity-btn.plus').addEventListener('click', () => {
    const input = document.getElementById('quantity');
    input.value = parseInt(input.value) + 1;
});

document.querySelector('.quantity-btn.minus').addEventListener('click', () => {
    const input = document.getElementById('quantity');
    if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
    }
});

// --- AÑADIR AL CARRITO CON AJAX ---
document.querySelector('.add-to-cart-form').addEventListener('submit', async function(e) {
    e.preventDefault(); // Prevenimos la recarga de la página

    const form = this;
    const btn = form.querySelector('.btn-add-cart');
    const sizeSelect = form.querySelector('select[name="size"]');

    // Validación simple
    if (!sizeSelect.value) {
        alert('Por favor, selecciona un tamaño.');
        return;
    }

    // Guardamos el estado original del botón
    const originalText = btn.textContent;
    const originalBg = btn.style.backgroundColor;

    // Mostramos feedback visual en el botón
    btn.textContent = '✓ Añadido';
    btn.style.backgroundColor = '#4CAF50'; // Verde éxito
    btn.disabled = true;

    try {
        const formData = new FormData(form);
        const response = await fetch("{{ url_for('add_to_cart') }}", {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.status === 'success') {
            // Actualizamos el contador del carrito en el header
            const cartCountEl = document.querySelector('.cart-count');
            if (cartCountEl) {
                const currentCount = parseInt(cartCountEl.textContent) || 0;
                const quantityAdded = parseInt(formData.get('quantity')) || 1;
                cartCountEl.textContent = currentCount + quantityAdded;
                cartCountEl.classList.add('animate'); // Animación de pulso
                setTimeout(() => cartCountEl.classList.remove('animate'), 500);
            }
        } else {
            alert(data.message || 'Hubo un error al añadir el producto.');
        }

    } catch (error) {
        console.error('Error al añadir al carrito:', error);
        alert('Error de conexión. Inténtalo de nuevo.');
    } finally {
        // Restauramos el botón después de un par de segundos
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.backgroundColor = originalBg;
            btn.disabled = false;
        }, 2000);
    }
});

// --- LÓGICA DEL ACORDEÓN ---
const accordionHeaders = document.querySelectorAll('.accordion-header');
accordionHeaders.forEach(header => {
    header.addEventListener('click', () => {
        const accordionItem = header.parentElement;
        const accordionContent = header.nextElementSibling;
        
        // Cierra otros acordeones abiertos para que solo uno esté abierto a la vez
        document.querySelectorAll('.accordion-item').forEach(item => {
            if (item !== accordionItem && item.classList.contains('active')) {
                item.classList.remove('active');
                item.querySelector('.accordion-content').style.maxHeight = null;
            }
        });

        // Abre o cierra el acordeón clickeado
        accordionItem.classList.toggle('active');
        if (accordionItem.classList.contains('active')) {
            accordionContent.style.maxHeight = accordionContent.scrollHeight + "px";
        } else {
            accordionContent.style.maxHeight = null;
        }
    });
});

</script>
{% endblock %}