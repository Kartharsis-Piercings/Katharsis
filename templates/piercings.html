{% extends 'base.html' %}

{% block title %}Guía de Piercings | Katharsis{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='piercings.css') }}">
{% endblock %}


{% block content %}
    <section class="hero" style=>
        <div class="hero-content">
            <h1>Guía de Piercings</h1>
            <p>Todo lo que necesitas saber para tu próxima perforación</p>
        </div>
    </section>

    <div class="piercing-guide-container">
        <aside class="piercing-nav">
            <button id="nav-toggle-btn" class="nav-toggle-btn">
                <i class="fas fa-bars"></i>
                Navegación
            </button>
            
            <h3>Navegación</h3>
            <ul id="guide-nav-list">
                {% for guide in piercings_data.guides %}
                    <li><a href="#{{ guide.id }}">{{ guide.title }}</a></li>
                {% endfor %}
            </ul>
        </aside>

        <main class="piercing-content">
            {% for guide in piercings_data.guides %}
                <section id="{{ guide.id }}" class="content-section">
                    
                    {% if guide.type == 'zone' %}
                        <h2>{{ guide.title }}</h2>
                        <div class="zone-description">{{ guide.zone_description | format_text | safe }}</div>
                    {% if guide.images %}
                        <div class="guide-main-image">
                            {# CORRECCIÓN: Quitamos replace(), pasamos la ruta SIN el /static/ inicial #}
                            {% set image_path = guide.images[0].replace('/static/', '', 1) %}
                            <img src="{{ url_for('static', filename=image_path) }}" alt="{{ guide.title }}">
                        </div>
                    {% endif %}
                        
                        {% for piercing in guide.piercings %}
                            <article class="piercing-article">
                                <h3>{{ piercing.name }}</h3>
                                <div class="piercing-main-content">
                                    <div class="piercing-info-text">
                                        <ul class="piercing-details-list">
                                            <li><strong><i class="fas fa-bolt"></i> Nivel de Dolor:</strong> {{ piercing.details.pain_level }}</li>
                                            <li><strong><i class="far fa-clock"></i> Cicatrización:</strong> {{ piercing.details.healing_time }}</li>
                                            <li><strong><i class="fas fa-gem"></i> Joyería Inicial:</strong> {{ piercing.details.initial_jewelry }}</li>
                                        </ul>
                                        <div>{{ piercing.description | format_text | safe }}</div>
                                    </div>
                                {% if piercing.images %}
                                <div class="piercing-images">
                                    {% for image in piercing.images %}
                                        {# CORRECCIÓN: Quitamos replace(), pasamos la ruta SIN el /static/ inicial #}
                                        {% set image_path = image.replace('/static/', '', 1) %}
                                        <img src="{{ url_for('static', filename=image_path) }}" alt="Ejemplo de {{ piercing.name }}">
                                    {% endfor %}
                                </div>
                                {% endif %}
                                </div>

                                <h4><i class="fas fa-medkit"></i> Consejos de Cuidado</h4>
                                <ul class="aftercare-list">
                                    {% for tip in piercing.aftercare_tips %}
                                        {# --- CHANGE IS HERE --- #}
                                        {# Apply format_text and safe filters to each tip #}
                                        <li>{{ tip | format_text | safe }}</li>
                                        {# --- END CHANGE --- #}
                                    {% endfor %}
                                </ul>

                                {% if piercing.recommended_products %}
                                    <h4><i class="fas fa-star"></i> Joyas Recomendadas</h4>
                                    <div class="related-products-grid">
                                        {% for product in piercing.recommended_products %}
                                            {% include 'product_card.html' %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </article>
                        {% endfor %}

                    {% elif guide.type == 'info' %}
                        <article class="piercing-article">
                            <h3>{{ guide.title }}</h3>
                            
                            <div class="info-content-constructor">
                                {% for block in guide.content_blocks %}
                                    {# Usamos una clase CSS dinámica basada en el tipo de bloque #}
                                    <div class="info-block block-{{ block.type }}">                      
                                        {# Condición para mostrar la imagen (si el bloque la tiene) #}
                                        {% if 'image' in block.type and block.image %}
                                    <div class="info-block-image">
                                        {% if block.image is mapping %}
                                            {% if block.image.pc %}
                                            {# CORRECCIÓN: Quitamos [8:], pasamos ruta SIN el / inicial #}
                                            <img src="{{ url_for('static', filename=block.image.pc.lstrip('/')) }}" alt="{{ guide.title }} - vista escritorio" class="responsive-image image-pc">
                                            {% endif %}
                                            {% if block.image.mobile %}
                                            {# CORRECCIÓN: Quitamos [8:], pasamos ruta SIN el / inicial #}
                                            <img src="{{ url_for('static', filename=block.image.mobile.lstrip('/')) }}" alt="{{ guide.title }} - vista móvil" class="responsive-image image-mobile">
                                            {% elif block.image.pc %}
                                            {# CORRECCIÓN: Quitamos [8:], pasamos ruta SIN el / inicial #}
                                            <img src="{{ url_for('static', filename=block.image.pc.lstrip('/')) }}" alt="{{ guide.title }} - vista móvil" class="responsive-image image-mobile">
                                            {% endif %}
                                        {% elif block.image is string %} {# Compatibilidad antigua #}
                                            {# CORRECCIÓN: Quitamos [8:], pasamos ruta SIN el / inicial #}
                                            <img src="{{ url_for('static', filename=block.image.lstrip('/')) }}" alt="{{ guide.title }}" class="responsive-image image-pc image-mobile">
                                        {% endif %}
                                    </div>
                                        {% endif %}

                                        {# Condición para mostrar el texto (si el bloque lo tiene) #}
                                        {% if 'text' in block.type or block.type in ['image_left', 'image_right'] %}
                                        <div class="info-block-text">
                                            {{ block.text | format_text | safe }}
                                        </div>
                                        {% endif %}

                                    </div>
                                {% endfor %}
                            </div>
                        </article>
                    {% endif %}

                </section>
            {% endfor %}
        </main>
    </div>

    <div class="quick-view-modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <div class="modal-product"></div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="{{ url_for('static', filename='product_card.js') }}"></script>
    <script src="{{ url_for('static', filename='catalog.js') }}"></script>
    {# ¡Añadiremos un nuevo archivo JS para esta página! #}
    <script src="{{ url_for('static', filename='piercings.js') }}"></script>
{% endblock %}